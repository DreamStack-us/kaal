name: Auto-Heal

on:
  workflow_dispatch:
    inputs:
      issue_id:
        description: "Healing issue ID (e.g., HEAL-2024-0115-001)"
        required: true
      error_type:
        description: "Type of error (type_error, build_error, test_error)"
        required: true
      error_context:
        description: "JSON error context from monitoring"
        required: true
      analysis:
        description: "Initial analysis and recommended fix approach"
        required: false

env:
  BUN_VERSION: "1.3.3"

jobs:
  heal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Setup Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Create healing branch
        run: |
          git checkout -b bugfix/auto-heal-${{ inputs.issue_id }}

      - name: Run Healing Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude-code --print --dangerously-skip-permissions \
            "You are the Kaal Healing Agent. Fix the following issue:

            Issue ID: ${{ inputs.issue_id }}
            Error Type: ${{ inputs.error_type }}

            Error Context:
            ${{ inputs.error_context }}

            Analysis:
            ${{ inputs.analysis }}

            Instructions:
            1. Analyze the error and identify the root cause
            2. Make the minimal fix necessary
            3. Ensure the fix follows project patterns (TypeScript strict)
            4. Run 'bun run lint' and 'bun run typecheck' to verify
            5. Commit your changes with message: 'fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}'
            "

      - name: Run verification
        run: |
          bun run lint
          bun run typecheck

      - name: Commit and push
        run: |
          git config user.name "Kaal Healing Bot"
          git config user.email "healing-bot@dreamstack.us"
          git add -A
          git diff --staged --quiet || git commit -m "fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}"
          git push origin bugfix/auto-heal-${{ inputs.issue_id }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bugfix/auto-heal-${{ inputs.issue_id }}
          base: main
          title: "fix(${{ inputs.error_type }}): auto-heal ${{ inputs.issue_id }}"
          body: |
            ## Auto-Heal PR

            **Issue ID:** `${{ inputs.issue_id }}`
            **Error Type:** `${{ inputs.error_type }}`

            ### Error Context
            ```json
            ${{ inputs.error_context }}
            ```

            ### Analysis
            ${{ inputs.analysis }}

            ---

            *This PR was automatically generated by the Kaal Self-Healing System.*
            *Please review carefully before merging.*

            - [ ] Code changes are minimal and targeted
            - [ ] No security implications
            - [ ] Tests pass
          labels: |
            auto-heal
            bot

      - name: Notify Slack
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "channel": "#kaal-alerts",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Auto-Heal PR Created"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Issue:* ${{ inputs.issue_id }}"},
                    {"type": "mrkdwn", "text": "*Type:* ${{ inputs.error_type }}"},
                    {"type": "mrkdwn", "text": "*Branch:* bugfix/auto-heal-${{ inputs.issue_id }}"},
                    {"type": "mrkdwn", "text": "*Status:* Ready for Review"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View PR"},
                      "url": "https://github.com/DreamStack-us/kaal/pulls",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }'

      - name: Notify Slack on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "channel": "#kaal-alerts",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Auto-Heal Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Issue `${{ inputs.issue_id }}` could not be auto-fixed. Manual intervention required."
                  }
                }
              ]
            }'
