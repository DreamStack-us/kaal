name: Deployment Notifications

on:
  push:
    branches:
      - develop
      - main
      - 'release/**'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Slack webhook
        id: check-slack
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::notice::Skipping Slack notification - SLACK_WEBHOOK_URL secret not configured"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-slack.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Get deployment info
        if: steps.check-slack.outputs.skip != 'true'
        id: info
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          BRANCH="${{ github.ref_name }}"

          if [[ "$BRANCH" == "main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "url=https://dreamstack-us.github.io/kaal/" >> $GITHUB_OUTPUT
            echo "version=prod-$SHORT_SHA" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "develop" ]]; then
            echo "environment=develop" >> $GITHUB_OUTPUT
            echo "url=https://kaal-dev.dreamstack.us" >> $GITHUB_OUTPUT
            echo "version=dev-$SHORT_SHA" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == release/* ]]; then
            # Extract version from branch name (release/v0.0.2 -> v0.0.2)
            VERSION="${BRANCH#release/}"
            echo "environment=staging ($VERSION)" >> $GITHUB_OUTPUT
            echo "url=Preview URL (check Vercel)" >> $GITHUB_OUTPUT
            echo "version=$VERSION-$SHORT_SHA" >> $GITHUB_OUTPUT
          fi

          # Get last 5 commits for changelog
          CHANGELOG=$(git log -5 --pretty=format:"* %s" --no-merges)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.check-slack.outputs.skip != 'true'
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "Kaal ${{ steps.info.outputs.environment }} deployment succeeded",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Environment:*\n${{ steps.info.outputs.environment }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Version:*\n${{ steps.info.outputs.version }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*URL:*\n<${{ steps.info.outputs.url }}|${{ steps.info.outputs.url }}>"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Triggered by:*\n${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Changes:*\n${{ steps.info.outputs.changelog }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Workflow",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Commit",
                            "emoji": true
                          },
                          "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
